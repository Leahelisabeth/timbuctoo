<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/0.10.4/js/jquery.terminal.min.js"></script>
  <script src="./viz.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/0.10.4/css/jquery.terminal.min.css" rel="stylesheet"/>
  <style>
    #term_demo {
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      position: absolute;
    }
    body {
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
      position: relative;
    }
  </style>
</head>
<body>
  <div id="term_demo"></div>
  <script>
  jQuery(function($, undefined) {
    $('#term_demo').terminal(function(command, term) {
      term.pause();
      var parts = command.split("|");
      var xhr = new XMLHttpRequest();
      xhr.open('POST', "/v2.1/gremlin");
      xhr.setRequestHeader("Content-type", "text/plain");
      if (parts.slice(-1)[0].trim().toLowerCase() == "excel") {
        command = parts.slice(0, -1).join("|");
        xhr.setRequestHeader("Accept", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        xhr.responseType = "blob";
        xhr.onload = function(e) {
          if (this.status == 200) {
            term.echo("File generated successfully");
            term.resume();
            var url = window.URL.createObjectURL(this.response);
            window.location = url;
          } else {
            var reader = new FileReader();
            reader.addEventListener("loadend", function() {
              term.echo(reader.result);
              term.resume();
            });
            reader.readAsText(this.response);
          }
        };
      } else if (parts.slice(-1)[0].trim().toLowerCase() == "graphviz") {
        command = parts.slice(0, -1).join("|");
        xhr.setRequestHeader("Accept", "text/vnd.graphviz");
        xhr.responseType = "text";
        xhr.onload = function(e) {
          term.echo(this.response);
          try {
            var rendered = Viz(this.response, { format:"svg", engine: "dot" });
            term.echo(rendered, {raw: true});
          } finally {
            term.resume();
          }
        };
      } else {
        xhr.responseType = 'text';
        xhr.setRequestHeader("Accept", "text/plain");
        xhr.responseType = "text";
        xhr.onload = function(e) {
          term.echo(this.response);
          term.resume();
        };
      }
      xhr.send(command);
    }, {
      greetings: 'Type a gremlin query such as: g.V().has("isLatest", true).has(T.label, LabelP.of("dcararchive")).limit(10)\nTo generate excel you pipe to excel: g.V().limit(10) | excel',
    });
  });
  </script>
</body>
